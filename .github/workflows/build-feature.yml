name: Build Feature Branch

on:
  push:
    branches:
      - 'copilot/**'
      - 'feature/**'
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install -q meson ffmpeg libass libplacebo luajit uchardet mujs \
            libarchive libbluray rubberband zimg vulkan-loader molten-vk

      - name: Build
        run: |
          meson setup build \
            -Dcocoa=enabled \
            -Dcoreaudio=enabled \
            -Dgl-cocoa=enabled \
            -Dvideotoolbox-gl=enabled \
            -Dvideotoolbox-pl=enabled \
            -Dmacos-cocoa-cb=enabled \
            -Dmacos-media-player=enabled \
            -Dmacos-touchbar=enabled \
            -Dswift-build=enabled \
            -Dvulkan=enabled
          meson compile -C build

      - name: Create App Bundle
        run: |
          meson compile -C build macos-bundle
          tar -czvf mpv-macos.tar.gz -C build mpv.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mpv-macos-arm64
          path: mpv-macos.tar.gz

  linux:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build nasm libffmpeg-nvenc-dev \
            libass-dev libbluray-dev libcdio-paranoia-dev libdvdnav-dev \
            libegl-dev libfreetype-dev libfribidi-dev libgl-dev libjpeg-dev \
            liblcms2-dev liblua5.2-dev libpulse-dev librubberband-dev \
            libsdl2-dev libuchardet-dev libvdpau-dev libvulkan-dev \
            libwayland-dev libx11-dev libxkbcommon-dev libxrandr-dev \
            libxss-dev libxv-dev libzimg-dev python3-pip \
            libavcodec-dev libavdevice-dev libavfilter-dev libavformat-dev \
            libavutil-dev libswresample-dev libswscale-dev libplacebo-dev

      - name: Build
        run: |
          meson setup build -Dlibmpv=true -Dtests=true
          meson compile -C build

      - name: Run tests
        run: |
          meson test -C build --suite libmpv -v
